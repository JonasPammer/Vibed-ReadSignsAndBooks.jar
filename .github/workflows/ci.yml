name: CI/CD Pipeline

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  JAVA_VERSION: "21"
  GRADLE_OPTS: -Dorg.gradle.daemon=true -Dorg.gradle.caching=true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build
        run: ./gradlew clean build -x test --stacktrace --info

      - name: Install xvfb for GUI tests
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Test
        run: xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" ./gradlew test --stacktrace
        # Coverage report is automatically generated via finalizedBy in build.gradle

      - name: Upload coverage reports to Codecov
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: build/test-results/**/*.xml
          check_name: Test Results
          comment_mode: always

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: build/reports/tests/
          retention-days: 14

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: build/reports/jacoco/
          retention-days: 14

      - uses: actions/upload-artifact@v4
        with:
          name: jar-artifact
          path: build/libs/ReadSignsAndBooks.jar
          retention-days: 90

  build-windows-zip:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build Windows distribution ZIP
        run: .\gradlew.bat clean build -x test createWindowsZip --stacktrace

      - uses: actions/upload-artifact@v4
        with:
          name: windows-zip-artifact
          path: ReadSignsAndBooks-Windows.zip
          retention-days: 90

  create-release:
    runs-on: ubuntu-latest
    needs: [build-and-test, build-windows-zip]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build
        run: ./gradlew clean build -x test --stacktrace

      - name: Get release info
        id: release_info
        run: |
          echo "date=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT
          echo "sha8=$(echo ${GITHUB_SHA} | cut -c1-8)" >> $GITHUB_OUTPUT
          echo "tag_name=release-$(echo ${GITHUB_SHA} | cut -c1-8)" >> $GITHUB_OUTPUT

      - name: Get commit message
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: jar-artifact
          path: build/libs/

      - name: Download Windows ZIP artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-zip-artifact
          path: ./

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ steps.release_info.outputs.tag_name }}"
          name: "Automated Release ${{ steps.release_info.outputs.date }}"
          body: |
            Old Releases will continously be deleted, please only link to:
            - JAR: https://github.com/JonasPammer/Vibed-ReadSignsAndBooks.jar/releases/latest/download/ReadSignsAndBooks.jar
            - Windows: https://github.com/JonasPammer/Vibed-ReadSignsAndBooks.jar/releases/latest/download/ReadSignsAndBooks-Windows.zip

            ## Files
            - **ReadSignsAndBooks.jar** - Cross-platform JAR file (requires Java 21+)
            - **ReadSignsAndBooks-Windows.zip** - Windows distribution with bundled JRE (extract and run EXE)

            ## Commit Message
            ${{ steps.commit.outputs.message }}

            ## Attribution
            This project would not exist without the code shared in 2020 by Matt (/u/worldseed) in the r/MinecraftDataMining 's Discord server,
            and it would be more than one file if not for the Querz NBT Library.

            All changes are just vibe coded with help of Claude 4.5.

            ---

            Commit: ${{ steps.release_info.outputs.sha8 }}
          files: |
            build/libs/ReadSignsAndBooks.jar
            ReadSignsAndBooks-Windows.zip
          make_latest: true

      - name: Delete old releases
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            // Get all releases
            const releases = await github.rest.repos.listReleases({
              owner,
              repo,
              per_page: 100
            });

            // Sort by created_at date (newest first)
            const sortedReleases = releases.data.sort((a, b) => {
              return new Date(b.created_at) - new Date(a.created_at);
            });

            console.log(`Total releases: ${sortedReleases.length}`);
            console.log('Keeping the 3 newest releases:');
            sortedReleases.slice(0, 3).forEach(r => {
              console.log(`  - ${r.name} (${r.created_at})`);
            });

            // Keep only the 3 newest releases
            const releasesToDelete = sortedReleases.slice(3);

            console.log(`Deleting ${releasesToDelete.length} old releases:`);
            for (const release of releasesToDelete) {
              console.log(`  Deleting: ${release.name} (${release.created_at}, ID: ${release.id})`);

              try {
                await github.rest.repos.deleteRelease({
                  owner,
                  repo,
                  release_id: release.id
                });
                console.log(`    ✓ Release deleted`);
              } catch (error) {
                console.log(`    ✗ Could not delete release: ${error.message}`);
              }
              
              // Note: We intentionally keep the tags to prevent "would clobber existing tag"
              // errors when users run `git pull --tags`. Tags are lightweight (just a SHA pointer)
              // and keeping them doesn't cause any issues.
            }
